<!DOCTYPE html>
<html lang="ko">
<head>
<link rel="apple-touch-icon" sizes="57x57" href="./apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="./apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="./apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="./apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="./apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="./apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="./apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="./apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="./apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="./android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="./favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
<link rel="manifest" href="./manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="./ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">
<meta charset="UTF-8">
<title>2048</title>
<style>
 body { overscroll-behavior-y: none; }
  #table { border-collapse: collapse; user-select: none; }
  #table td {
    border: 10px solid #bbada0; width: 116px; height: 128px;
    font-size: 50px; font-weight: bold; text-align: center;
  }
  #score { user-select: none; }
  .color-2 { background-color: #eee4da; color: #776e65;}
  .color-4 { background-color: #eee1c9; color: #776e65;}
  .color-8 { background-color: #f3b27a; color: 'white';}
  .color-16 { background-color: #f69664; color: 'white';}
  .color-32 { background-color: #f77c5f; color: 'white';}
  .color-64 { background-color: #f75f3b; color: 'white';}
  .color-128 { background-color: #edd073; color: #776e65;}
  .color-256 { background-color: #edcc62; color: #776e65;}
  .color-512 { background-color: #edc950; color: #776e65;}
  .color-1024 { background-color: #edc53f; color: #776e65;}
  .color-2048 { background-color: #edc22e; color: #776e65;}
</style>
</head>
<body>
<table id="table"></table>
<div>
  <h1 id="info">í˜„ì¬ ë¸Œë¼ìš°ì €ì˜ ì„¤ì • êµ¬íšì—ì„œ javascriptì‚¬ìš©ì„ í—ˆìš©í•˜ì§€ ì•Šê³ ìˆê±°ë‚˜ ë´‰ì‚¬ê¸°ì˜ ì‘ë™ì´ ë©ˆì¶”ì—ˆì„ìˆ˜ ìˆìŠµë„¤ë‹¤. ë”°ë¼ì„œ í˜„ì¬ ì´ ì°½ì„ ì •ìƒì ìœ¼ë¡œ ë ¬ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</h1>
</div>
<script>
  const congratulation_audio = new Audio('congratulation.wav');
  const lose_audio = new Audio('2048Lose_Mastering.wav');
  const $info = document.getElementById('info');
  $info.textContent = '';
  /*
  const url = new URL(window.location.href);
  const urlParams = url.searchParams;
  const score = urlParams.get('score');
  const win = urlParams.get('win');
  */
  let score_with_win = undefined;
  let win = undefined;
  let score = undefined;
  let game_window = undefined;
  $info.textContent = 'ê²Œì„ ê²°ê³¼ë¥¼ ê¸°ë¡í•˜ê¸°ìœ„í•œ ì°½ì…ë‹ˆë‹¤. ì°½ì„ ë‹«ì„ì‹œê¸°ë¡ì´ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê¸°ë¡ì„ ì›í•˜ì§€ ì•Šì„ ê²½ìš° ì´ì°½ì„ ë‹«ê³ , ê¸°ë¡ì„ ì›í•˜ì‹¤ê²½ìš° ì´ì°½ì„ ì—´ì–´ë‘ì‹­ì‹œì˜¤.';
  let test_window = undefined;
  if (location.href == 'http://127.0.0.1:5500/2048_Result.html'){
    test_window = window.open('http://127.0.0.1:5500/popup.html');
  } else if (location.href == 'https://project-dy.github.io/project-dy/2048_Result.html') {
    test_window = window.open('https://project-dy.github.io/project-dy/popup.html')
  };
  let test = undefined;
  if (!test_window) {
    $info.textContent = 'íŒì—…ì°¨ë‹¨ì„ í•´ì œí›„ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.'
  } else {
    if (location.href == 'http://127.0.0.1:5500/2048_Result.html'){
      game_window = window.open('http://127.0.0.1:5500/2048.html');
    } else if (location.href == 'https://project-dy.github.io/project-dy/2048_Result.html') {
      game_window = window.open('https://project-dy.github.io/project-dy/2048.html')
    };
  };
  const receiveMessage = async (e) => {
    if(e.data.hasOwnProperty('score')){
      console.log(e);
      console.log(e.data.score);
      console.log(e.data.win);
      win = e.data.win;
      console.log(win);
      // startrecord(parseInt(e.data.score));
      score = e.data.score;
      startrecord(score);
    };
  };
  window.addEventListener("message", receiveMessage, false);

  function startrecord(n) {
    if (win == 0) { // Lose
      document.write(n+'ì  ìœ¼ë¡œ íŒ¨ë°°!');
      /*try {
        lose_audio.play();
      } catch(e) {
        console.log(`ìŒì•… ì¬ìƒ ë¶ˆê°€. ERROR ë‚´ìš©:${e}`);
      };*/
    } else if (win == 1) {
      document.write(n+'ì  ìœ¼ë¡œ ìŠ¹ë¦¬!');
      /*try {
        congratulation_audio.play();
      } catch(e) {
        console.log(`ìŒì•… ì¬ìƒ ë¶ˆê°€. ERROR ë‚´ìš©:${e}`);
      };*/
    };
    login(n);
  };

  let restart_function = 0
  function login(n){
    console.log(n+'ì ì„ ê¸°ë¡.');
    let game_window_close = 0
    setTimeout(() => {
      const name = prompt('ë‹¹ì‹ ì˜ ë‹‰ë„¤ì„ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.');
      if(name == null) {
        alert('ê¸°ë¡ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        return;
      };
      const pw = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
      if(pw == null) {
        alert('ê¸°ë¡ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        return;
      };
      console.log(pw);
      if(name){
        console.log('ë‹‰ë„¤ì„: ' + name);
        let name_list = false;
        if(window.localStorage.getItem(name)){
          name_list = window.localStorage.getItem(name);
          console.log(String(name_list)+String(pw));
          if(name_list == true){
            console.log('ê°€ì…í•„ìš”.');
            pw1 == prompt('ì‹ ê·œ ê°€ì…ì¤‘...\në¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ í•œë²ˆ ì…ë ¥í•´ì£¼ì„¸ìš”');
            if(pw == pw1){
              window.localStorage.setItem(name, pw);
              console.log('ì™„ë£Œ');
            } else if (pw1 == window.localStorage.getItem(pw)) {
              alert('ì‚¬ìš© ë¶ˆê°€ëŠ¥í•œ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.');
              restart_function = 1;
              return;
            } else{
              console.log('ë¹„ë°€ë²ˆí˜¸ í‹€ë¦¼');
              alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
              restart_function = 1
              return;
            };
          } else if(name_list == pw){
            console.log('ê¸°ë¡ ë˜ì–´ìˆëŠ” ë‹‰ë„¤ì„.');
          } else{
            console.log('ë¹„ë°€ë²ˆí˜¸ í‹€ë¦¼');
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
            restart_function = 1
            return;
          };
        } else {
          console.log('ì‹ ê·œ');
          const pw1 = prompt('ì‹ ê·œ ê°€ì…ì¤‘...\në¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
          if(pw == pw1){
          window.localStorage.setItem(name, pw);
          console.log('ì™„ë£Œ');
          alert('ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë³¸ ê³„ì •ì€ ë³¸ ê¸°ê¸°ì— í•œí•˜ì—¬ ì‚¬ìš©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.')
          } else{
            console.log('ë¹„ë°€ë²ˆí˜¸ í‹€ë¦¼');
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
            restart_function = 1;
          }
        };
        if(restart_function == 1){
          restart_function = 0;
          login(n);
        }
        else{
          record(n, name, pw);
        };
        // return;
      } else{
        return;
      }
    }, 100);;
  }
  /*if(restart_function == 1){
    restart_function = 0;
    login(n);
  };*/
  function record(n, name, pw){
    console.log('ê¸°ë¡ ì‹œì‘');
    if(name === null || pw === null) {
      alert('ê¸°ë¡ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      console.log('ì·¨ì†Œ!');
      return;
    };
    if(!window.localStorage.getItem(pw)) {
      console.log('ì²«ë²ˆì§¸ ê¸°ë¡!');
      window.localStorage.setItem(pw,n);
      console.log('ê¸°ë¡ ì™„ë£Œ!');
    } else{
      console.log('ì´ì „ì˜ ê¸°ë¡ ë°œê²¬!');
      const prev = window.localStorage.getItem(pw);
      if(prev < n){
        window.localStorage.setItem(pw,n);
        console.log('ìµœê³ ê¸°ë¡ ë‹¬ì„±!');
        alert(n+'ì \nìµœê³ ê¸°ë¡ ë‹¬ì„±!\nì¶•í•˜ë“œë¦½ë‹ˆë‹¤!!ğŸ‰ğŸ‰');
        console.log('ì™„ë£Œ');
      } else if(prev > n){
        const prev_temp = prev-n;
        alert(prev_temp+'ì  ì°¨ì´ë¡œ ì•„ì‰½ê²Œ ì‹¤íŒ¨!');
        const want_record = confirm('ê¸°ë¡ì„ ê°±ì‹  í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
        if(want_record){
          if(confirm('ê¸°ì¡´ê¸°ë¡ì€ ì‚­ì œ ë©ë‹ˆë‹¤.\nê·¸ë˜ë„ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
            window.localStorage.setItem(pw,n);
            console.log('ì™„ë£Œ')
          } else{
            console.log('cancled');
          };
          return;
        } else{
          return;
        };
      } else{
        console.log('ë™ì !')
        alert(n+'ì ìœ¼ë¡œ ë™ì ì…ë‹ˆë‹¤.')
      };
    };
  }
</script>
</body>
</html>
