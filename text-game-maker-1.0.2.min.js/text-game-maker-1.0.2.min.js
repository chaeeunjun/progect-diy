/*
 * Copyright 2019 a.mean.blogger@gmail.com
 * GitHub: https://github.com/a-mean-blogger/text-game-maker-js
 * license: MIT
 */
var TM={version:"1.0.2",defaultSettings:{screen:{canvasId:"tm-canvas",frameSpeed:40,column:60,row:20,backgroundColor:"#151617",webFontJsPath:"https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js",fontFaceObserverJsPath:"https://cdnjs.cloudflare.com/ajax/libs/fontfaceobserver/2.0.13/fontfaceobserver.js",fontColor:"#F5F7FA",fontFamily:"Nanum Gothic Coding",fontSource:"https://cdn.jsdelivr.net/font-nanum/1.0/nanumgothiccoding/nanumgothiccoding.css",fontSize:30,zoom:.5},charGroups:{korean:{chars:"ㄱ-힣",isFullwidth:!0,sizeAdj:1,xAdj:0,yAdj:0},fullwidth:{targetFonts:["Nanum Gothic Coding"],chars:" •←-⇰─-⯿",isFullwidth:!0,sizeAdj:1.2,xAdj:-.05,yAdj:.03}},debug:{devMode:!1,outputDomId:"tm-debug-output"}},common:{}};TM.common.getBlockWidth=function(t){return.6*t},TM.common.getBlockHeight=function(t){var e;if(t<3)e=t;else{var r=[6,7,7],n=0,o=1,i=function(t){t-r[n]<=0||(t-=r[n],o++,n=(n+1)%3,i(t))};i(t-3),e=t+o}return e},TM.common.isNumber=function(t){return!!(0===t||t&&t.constructor==Number)},TM.common.getCharGroup=function(t,e){for(var r in t){var n=t[r];if(!n.targetFonts||-1!=n.targetFonts.indexOf(e.font))if(new RegExp("^["+n.chars+"]$").test(e.char))return n}},TM.common.getFullwidthRegex=function(t,e){var r="";for(var n in t){var o=t[n];o.targetFonts&&-1==o.targetFonts.indexOf(e)||o&&o.isFullwidth&&(r+=o.chars)}if(r)return new RegExp("(["+r+"])","g")},TM.common.includeScript=function(t){if(t){var e=document.querySelector('script[src="'+t+'"]');e||((e=document.createElement("script")).src=t,document.getElementsByTagName("head")[0].appendChild(e))}},TM.common.mergeObjects=function(t,e){for(var r={},n=[t,e],o=0;o<n.length;o++)for(var i in n[o])r[i]=n[o][i];return r},TM.IObject=function(t,e){this.isActive=null,this.data=TM.common.mergeObjects(this.data,t),e||this.init()},TM.IObject.prototype.init=function(){this._init(),this.isActive=!0},TM.IObject.prototype.inactivate=function(){this._inactivate(),this.isActive=!1},TM.IObject.prototype._init=function(){},TM.IObject.prototype._inactivate=function(){},TM.Interval=function(t,e){this.data={},this.speed=t,this.func=e,this.intervalId=null,TM.IObject.call(this,null,!0)},TM.Interval.prototype=Object.create(TM.IObject.prototype),TM.Interval.prototype.constructor=TM.Interval,TM.Interval.prototype._init=function(){this.stopInterval(),this.startInterval()},TM.Interval.prototype._inactivate=function(){this.stopInterval()},TM.Interval.prototype.setSpeed=function(t){this.speed=t,this.stopInterval(),this.init()},TM.Interval.prototype.stopInterval=function(){this.intervalId&&window.clearInterval(this.intervalId),this.intervalId=null},TM.Interval.prototype.startInterval=function(){var t=this;this.intervalId=window.setInterval(function(){t.func()},this.speed)},TM.ILoopObject=function(t,e,r){this.speed=t;var n=this;this.interval=new TM.Interval(this.speed,function(){n.isActive&&n.calculate(),n.isActive&&n.draw()}),TM.IObject.call(this,e,r)},TM.ILoopObject.prototype=Object.create(TM.IObject.prototype),TM.ILoopObject.prototype.constructor=TM.ILoopObject,TM.ILoopObject.prototype.init=function(){TM.IObject.prototype.init.call(this),this.interval.init(),this.draw()},TM.ILoopObject.prototype.inactivate=function(){TM.IObject.prototype.inactivate.call(this),this.interval.inactivate()},TM.ILoopObject.prototype.calculate=function(){this._calculate()},TM.ILoopObject.prototype.draw=function(){this._draw()},TM.ILoopObject.prototype._init=function(){},TM.ILoopObject.prototype._inactivate=function(){},TM.ILoopObject.prototype._calculate=function(){},TM.ILoopObject.prototype._draw=function(){},TM.IProgram=function(t,e,r){this.loopCount=0,this.objects=TM.common.mergeObjects(this.objects,r),TM.ILoopObject.call(this,t,e,!0)},TM.IProgram.prototype=Object.create(TM.ILoopObject.prototype),TM.IProgram.prototype.constructor=TM.IProgram,TM.IProgram.prototype.init=function(){TM.ILoopObject.prototype.init.call(this),this.loopCount=0},TM.IProgram.prototype.inactivate=function(){for(var t in TM.ILoopObject.prototype.inactivate.call(this),this.objects)if(Array.isArray(this.objects[t]))for(var e=this.objects[t].length-1;0<=e;e--)this.objects[t][e].inactivate();else this.objects[t]&&this.objects[t].inactivate()},TM.IProgram.prototype.calculate=function(){TM.ILoopObject.prototype.calculate.call(this),this.loopCount++,this.timeline(this.loopCount),this.getInput()},TM.IProgram.prototype.draw=function(){TM.ILoopObject.prototype.draw.call(this),this._draw()},TM.IProgram.prototype.timeline=function(t){this._timeline(t)},TM.IProgram.prototype.getInput=function(){this._getInput()},TM.IProgram.prototype._init=function(){},TM.IProgram.prototype._inactivate=function(){},TM.IProgram.prototype._calculate=function(){},TM.IProgram.prototype._draw=function(){},TM.IProgram.prototype._timeline=function(t){},TM.IProgram.prototype._getInput=function(){},TM.ScreenManager_Char=function(t,e,r,n,o,i){this.screenSetting=t,this.char=e,this.isFullwidth=i,this.color=r||t.fontColor,this.backgroundColor=n||t.backgroundColor,this.font=o||t.fontFamily,this.isNew=!0,TM.IObject.call(this)},TM.ScreenManager_Char.prototype=Object.create(TM.IObject.prototype),TM.ScreenManager_Char.prototype.constructor=TM.ScreenManager_Char,TM.ScreenManager_Char.prototype._init=function(){},TM.ScreenManager_Char.prototype._inactivate=function(){},TM.ScreenManager_Char.prototype.update=function(t,e,r,n,o){this.char=t||" ",this.fullwidth=o||!1,this.color=e||this.screenSetting.fontColor,this.backgroundColor=r||this.screenSetting.backgroundColor,this.font=n||this.screenSetting.fontFamily,this.isNew=!0},TM.ScreenManager_Cursor=function(t){this.speed=500,this.refScreenManager=t,this.x=0,this.y=0,this.fixedX=void 0,this.fixedY=void 0,this.xMax=this.refScreenManager.screenSetting.column-1,this.yMax=this.refScreenManager.screenSetting.row-1,this.color=this.refScreenManager.screenSetting.fontColor,this.width=this.refScreenManager.blockWidth,this.size=.1,this.isHidden=!1,this.blinkFlag=!1,this.isUpdated=!0,TM.ILoopObject.call(this,this.speed)},TM.ScreenManager_Cursor.prototype=Object.create(TM.ILoopObject.prototype),TM.ScreenManager_Cursor.prototype.constructor=TM.ScreenManager_Cursor,TM.ScreenManager_Cursor.prototype._init=function(){this.blinkFlag=!1,this.isHidden=!1},TM.ScreenManager_Cursor.prototype._inactivate=function(){this.blinkFlag=!0,this.requestDraw()},TM.ScreenManager_Cursor.prototype._calculate=function(){this.blinkFlag=!this.blinkFlag,this.requestDraw()},TM.ScreenManager_Cursor.prototype._draw=function(){},TM.ScreenManager_Cursor.prototype.changeColor=function(t){this.color=t||this.refScreenManager.screenSetting.fontColor,this.requestDraw()},TM.ScreenManager_Cursor.prototype.pin=function(t,e){this.requestDraw(),this.fixedX=null!=t?t:this.x,this.fixedY=null!=e?e:this.y,this.requestDraw()},TM.ScreenManager_Cursor.prototype.unpin=function(){this.x=null!=this.fixedX?this.fixedX:this.x,this.y=null!=this.fixedY?this.fixedY:this.y,this.fixedX=void 0,this.fixedY=void 0,this.requestDraw()},TM.ScreenManager_Cursor.prototype.move=function(t,e){var r=!1;return this.isActive&&0<=t&&t<=this.xMax&&0<=e&&e<=this.yMax&&(r=!0,this.requestDraw(),this.x=t,this.y=e,this.requestDraw()),r},TM.ScreenManager_Cursor.prototype.requestDraw=function(){var t=null!=this.fixedX?this.fixedX:this.x,e=null!=this.fixedY?this.fixedY:this.y;this.isUpdated=!0,this.refScreenManager.screen.data[e+this.refScreenManager.scrollOffsetY][t].isNew=!0,this.refScreenManager.requestDraw()},TM.ScreenManager_Cursor.prototype.hide=function(){this.isHidden=!0,this.blinkFlag=!0,this.interval.inactivate(),this.requestDraw()},TM.ScreenManager_Cursor.prototype.show=function(){this.init(),this.requestDraw()},TM.ScreenManager_Cursor.prototype.copy=function(){return TM.common.mergeObjects(this)},TM.ScreenManager_Cursor.prototype.paste=function(t){for(var e in TMS.cursor)null!=TMS.cursor[e]&&"function"!=typeof TMS.cursor[e]&&(TMS.cursor[e]=t[e]);t.isHidden?this.hide():this.show()},TM.ScreenManager=function(t,e){this.screenSetting=TM.common.mergeObjects(TM.defaultSettings.screen,t),this.charGroups=TM.common.mergeObjects(TM.defaultSettings.charGroups,e),this.speed=this.screenSetting.frameSpeed;try{if(this.canvas=document.querySelector("#"+this.screenSetting.canvasId),!this.canvas)throw"[#"+this.screenSetting.canvasId+"] does not exist! ";if("CANVAS"!==this.canvas.tagName)throw"[#"+this.screenSetting.canvasId+"] is not a canvas! "}catch(t){return this.isActive=!1,void console.error("new TM.ScreenManager ERROR: "+t+" TM.ScreenManager is not created correctly.")}var r=TM.common.getBlockWidth(this.screenSetting.fontSize),n=TM.common.getBlockHeight(this.screenSetting.fontSize);this.canvas.width=r*this.screenSetting.column,this.canvas.height=n*this.screenSetting.row,this.canvas.style.width=this.canvas.width*this.screenSetting.zoom+"px",this.canvas.style.height=this.canvas.height*this.screenSetting.zoom+"px",this.canvas.tabIndex=1,this.canvas.style.outline="none",this.ctx=this.canvas.getContext("2d"),this.canvasContainer=document.createElement("div"),this.canvasContainer.style.position="relative",this.canvasContainer.width=this.canvas.width,this.canvasContainer.height=this.canvas.height,this.canvasContainer.style.border=this.screenSetting.backgroundColor+" 1px solid",this.canvasContainer.style.borderRadius="5px",this.canvasContainer.style.backgroundColor=this.screenSetting.backgroundColor,this.canvasContainer.style.width=this.canvas.width*this.screenSetting.zoom+"px",this.canvasContainer.style.height=this.canvas.height*this.screenSetting.zoom+"px",this.canvasContainer.style.overflow="hidden",this.canvas.parentNode.insertBefore(this.canvasContainer,this.canvas),this.canvasContainer.appendChild(this.canvas),this.scrollOffsetY=0,this.isFontLoaded=!1,this.blockWidth=r,this.blockHeight=n,this.screen={data:[],isDrawRequested:!1,isDrawProcessed:!0},this.cursor=new TM.ScreenManager_Cursor(this),TM.ILoopObject.call(this,this.speed)},TM.ScreenManager.prototype=Object.create(TM.ILoopObject.prototype),TM.ScreenManager.prototype.constructor=TM.ScreenManager,TM.ScreenManager.prototype._init=function(){this.resetScreenData(),this.screenSetting.fontSource?this.startLoadingFont():this.isFontLoaded=!0},TM.ScreenManager.prototype._inactivate=function(){},TM.ScreenManager.prototype._calculate=function(){this.checkReady()?this.onReadyFunc&&(this.onReadyFunc(),delete this.onReadyFunc):this.drawSystemMessage("Loading...")},TM.ScreenManager.prototype.draw=function(){if(!0===this.screen.isDrawRequested){this.screen.isDrawRequested=!1;var t=this;window.requestAnimationFrame(function(){t.drawAnimationFrame()})}},TM.ScreenManager.prototype.requestDraw=function(){this.screen.isDrawProcessed&&(this.screen.isDrawProcessed=!1,this.screen.isDrawRequested=!0)},TM.ScreenManager.prototype.drawAnimationFrame=function(){this.screen.isDrawProcessed=!0;var t=this.ctx;t.textBaseline="buttom";for(var e=this.getNewBgUpdateMap(),r=this.scrollOffsetY;r<this.scrollOffsetY+this.screenSetting.row;r++)for(var n=0;n<this.screenSetting.column;n++){if(!0===this.screen.data[r][n].isNew){if(!e[r][n]){var o=this.blockWidth*n,i=this.blockHeight*(r-this.scrollOffsetY),s=this.getBackgroundWidthRecursive(r,n,e),a=this.blockHeight;t.fillStyle=this.screen.data[r][n].backgroundColor,t.fillRect(o,i,s,a)}if(this.screen.data[r][n].char&&"$"!=this.screen.data[r][n].char[0]){var c=this.blockWidth*n,h=this.blockHeight*(r-this.scrollOffsetY)+.8*this.blockHeight,u=TM.common.getCharGroup(this.charGroups,this.screen.data[r][n]);u?(t.font=this.screenSetting.fontSize*u.sizeAdj+"px "+this.screen.data[r][n].font,c+=this.blockWidth*u.xAdj,h+=this.blockHeight*u.yAdj):t.font=this.screenSetting.fontSize+"px "+(this.isFontLoaded?this.screen.data[r][n].font:"monospace"),t.fillStyle=this.screen.data[r][n].color,t.fillText(this.screen.data[r][n].char[0],c,h)}this.screen.data[r][n].isNew=!1}if(!this.screen.data[r][n].isActive){this.screen.data[r][n].backgroundColor=this.screenSetting.backgroundColor;var d=this.blockWidth*n,l=this.blockHeight*(r-this.scrollOffsetY),p=this.blockWidth,g=this.blockHeight;t.fillStyle=this.screen.data[r][n].backgroundColor,t.fillRect(d,l,p,g)}if(this.cursor.isUpdated)if(this.cursor.blinkFlag)this.cursor.isUpdated=!1;else{var M=void 0!==this.cursor.fixedX?this.cursor.fixedX:this.cursor.x,f=void 0!==this.cursor.fixedY?this.cursor.fixedY:this.cursor.y;if(n==M&&r-this.scrollOffsetY==f){this.cursor.isUpdated=!1;var y=this.cursor.width,v=this.blockHeight*this.cursor.size,T=(M=this.blockWidth*M,f=this.blockHeight*f+(this.blockHeight-v),this.cursor.color);t.fillStyle=T,t.fillRect(M,f,y,v)}}}},TM.ScreenManager.prototype.startLoadingFont=function(t){var e=t||this;if(!e.screenSetting.webFontJsPath)return console.error("TM.ScreenManager ERROR: 'webFontJsPath' is required to load font from 'fontSource'!");if(!e.screenSetting.fontFaceObserverJsPath)return console.error("TM.ScreenManager ERROR: 'fontFaceObserverJsPath' is required to load font from 'fontSource'!");var r=!0;window.WebFont||(r=!1,TM.common.includeScript(e.screenSetting.webFontJsPath)),window.FontFaceObserver||(r=!1,TM.common.includeScript(e.screenSetting.fontFaceObserverJsPath)),r?e.loadWebFont():setTimeout(function(){TM.ScreenManager.prototype.startLoadingFont(e)},100)},TM.ScreenManager.prototype.loadWebFont=function(){WebFont.load({custom:{families:[this.screenSetting.fontFamily],urls:[this.screenSetting.fontSource]}});var t=new FontFaceObserver(this.screenSetting.fontFamily),e=this;t.load().then(function(){e.isFontLoaded=!0,e.refreshScreen(),e.drawSystemMessage("Loading...",!0)},function(){e.isFontLoaded=!0;var t="TM.ScreenManager ERROR: Cannot load font: "+e.screenSetting.fontFamily;e.drawSystemMessage(t),console.error(t)})},TM.ScreenManager.prototype.resetScreenData=function(){this.screen.data=[];for(var t=this.scrollOffsetY;t<this.scrollOffsetY+this.screenSetting.row;t++){this.screen.data[t]=[];for(var e=0;e<this.screenSetting.column;e++)this.screen.data[t][e]=new TM.ScreenManager_Char(this.screenSetting," ")}},TM.ScreenManager.prototype.getNewBgUpdateMap=function(){for(var t=[],e=this.scrollOffsetY;e<this.scrollOffsetY+this.screenSetting.row;e++){t[e]=[];for(var r=0;r<this.screenSetting.column;r++)t[e][r]=!1}return t},TM.ScreenManager.prototype.getBackgroundWidthRecursive=function(t,e,r){return r[t][e]=!0,e+1<this.screenSetting.column&&this.screen.data[t][e+1].isNew&&this.screen.data[t][e].backgroundColor==this.screen.data[t][e+1].backgroundColor?this.getBackgroundWidthRecursive(t,e+1,r)+this.blockWidth:this.blockWidth},TM.ScreenManager.prototype.refreshScreen=function(){for(var t=0;t<this.screen.data.length;t++)for(var e=0;e<this.screen.data[t].length;e++)this.screen.data[t][e].isNew=!0;this.requestDraw()},TM.ScreenManager.prototype.isInScreen=function(t,e){var r=!1;return 0<=t&&0<=e&&e<this.screenSetting.row&&t<this.screenSetting.column&&(r=!0),r},TM.ScreenManager.prototype.insertChar=function(t,e,r,n,o){var i=this.cursor.x,s=this.cursor.y,a=this.cursor.x,c=this.cursor.y+this.scrollOffsetY;this.isInScreen(i,s)&&((this.screen.data[c][a].char!=t||this.screen.data[c][a].color!=(e||this.screenSetting.fontColor)||this.screen.data[c][a].backgroundColor!=(r||this.screenSetting.backgroundColor)||this.screen.data[c][a].font!=(n||this.screenSetting.fontFamily)||"$"==this.screen.data[c][a].char[0]&&0<a-1&&this.screen.data[c][a-1].isNew)&&(this.screen.data[c][a].update(t,e,r,n,o),this.isInScreen(i-1,s)&&(this.screen.data[c][a-1].draw=!0),this.isInScreen(i+(o?2:1),s)&&(this.screen.data[c][a+(o?2:1)].draw=!0),this.requestDraw()),"$"==this.screen.data[c][a].char[0]&&0==a||(i+1>=this.screenSetting.column&&s+1<this.screenSetting.row?this.cursor.move(0,s+1):i+1>=this.screenSetting.column&&s+1>=this.screenSetting.row?(this.cursor.move(0,s),this.scrollDown()):this.cursor.move(i+1,s)))},TM.ScreenManager.prototype.drawSystemMessage=function(t,e){var r=this.cursor.x,n=this.cursor.y;e?this.deleteTextAt(0,0,t):this.insertTextAt(0,0,t),this.cursor.move(r,n)},TM.ScreenManager.prototype.onReady=function(t){this.checkReady()?this.onReadyFunc():this.onReadyFunc=t},TM.ScreenManager.prototype.checkReady=function(){return!this.screenSetting.fontSource||this.isFontLoaded},TM.ScreenManager.prototype.fillScreen=function(t,e,r){for(var n=this.scrollOffsetY;n<this.scrollOffsetY+this.screenSetting.row;n++)for(var o=0;o<this.screenSetting.column;o++)this.screen.data[n][o].update(t,!1,e,r);this.requestDraw()},TM.ScreenManager.prototype.scrollDown=function(){var t=this.scrollOffsetY+this.screenSetting.row;if(!this.screen.data[t]){this.screen.data[t]=[];for(var e=0;e<this.screenSetting.column;e++)this.screen.data[t][e]=new TM.ScreenManager_Char(this.screenSetting," ")}this.scrollOffsetY++,this.refreshScreen()},TM.ScreenManager.prototype.scrollUp=function(){0<this.scrollOffsetY&&this.scrollOffsetY--,this.refreshScreen()},TM.ScreenManager.prototype.clearScreen=function(){this.cursor.move(0,0),this.scrollOffsetY=0,this.fillScreen(" ")},TM.ScreenManager.prototype.insertText=function(t,e,r,n){n=n||this.screenSetting.fontFamily;var o=TM.common.getFullwidthRegex(this.charGroups,n);o&&(t=t.toString().replace(o,"$1 "));for(var i=this.cursor.x,s=0;s<t.length;s++)switch(t[s]){case"\n":this.cursor.y+1<this.screenSetting.row?this.cursor.move(i,this.cursor.y+1):(this.cursor.move(i,this.cursor.y),this.scrollDown());break;case"\r":this.cursor.move(0,this.cursor.y),i=0;break;default:var a=!!o&&new RegExp(o).test(t[s]);this.insertChar(t[s],e,r,n,a),a&&(s++,this.insertChar("$fullwidthFiller",e,r,n))}return{x:this.cursor.x,y:this.cursor.y}},TM.ScreenManager.prototype.insertTextAt=function(t,e,r,n,o,i){if(this.cursor.move(t,e))return this.insertText(r,n,o,i)},TM.ScreenManager.prototype.deleteText=function(t,e){e=e||this.screenSetting.fontFamily;var r=TM.common.getFullwidthRegex(this.charGroups,e);t=t.toString().replace(r,"$1 "),this.insertText(t.replace(/./g," "),null,null,e)},TM.ScreenManager.prototype.deleteTextAt=function(t,e,r){this.cursor.move(t,e)&&this.deleteText(r)},TM.ScreenManager.prototype.copyScreen=function(){var t=document.createElement("canvas"),e=t.getContext("2d");return t.width=this.canvas.width,t.height=this.canvas.height,e.drawImage(this.canvas,0,0),t},TM.ScreenManager.prototype.pasteScreen=function(t){this.ctx.drawImage(t,0,0)},TM.ScreenManager.prototype.consoleScreenData=function(t){for(var e=this.scrollOffsetY;e<this.scrollOffsetY+this.screenSetting.row;e++){for(var r="",n=0;n<this.screenSetting.column;n++)r+=this.screen.data[e][n].char[0]+(this.screen.data[e][n].isNew?"!":" ");console.log(r)}},TM.InputManager_Keyboard=function(t){this.refInputManager=t,this.keyState={},this.keyPressed={},this.textBox={dom:void 0,value:void 0,maxLength:void 0,callback:function(t){},interval:void 0,cursorSnap:void 0};var e=this;this.eventHandlers={keydown:function(t){t.preventDefault(),e.refInputManager.isActive&&e.isActive&&(e.keyState[t.keyCode]=!0,e.keyPressed[t.keyCode]=!0),e.refInputManager.devMode&&e.refInputManager.isActive&&e.isActive&&console.log("Keyboard Key Pressed keyCode: ",t.keyCode)},keyup:function(t){t.preventDefault(),delete e.keyState[t.keyCode]},textBoxFocus:function(t){e.textBox.dom.focus()},textBoxKeydown:function(t){13==t.keyCode&&(TMS.cursor.paste(e.textBox.cursorSnap),e.truncateText(),TMS.cursor.unpin(),window.clearInterval(e.textBox.interval),TMS.canvasContainer.removeChild(e.textBox.dom),TMS.canvas.removeEventListener("focus",e.eventHandlers.textBoxFocus),e.textBox.dom.removeEventListener("keyup",e.eventHandlers.textBoxKeydown),e.textBox.dom=void 0,e.textBox.callback(e.textBox.value),TMS.canvas.focus())}},TM.IObject.call(this)},TM.InputManager_Keyboard.prototype=Object.create(TM.IObject.prototype),TM.InputManager_Keyboard.prototype.constructor=TM.InputManager_Keyboard,TM.InputManager_Keyboard.prototype._init=function(){this.refInputManager.targetDom.addEventListener("keydown",this.eventHandlers.keydown),this.refInputManager.targetDom.addEventListener("keyup",this.eventHandlers.keyup)},TM.InputManager_Keyboard.prototype._inactivate=function(){this.keyState={},this.keyPressed={}},TM.InputManager_Keyboard.prototype.getText=function(t,e){if(!(TMS instanceof TM.ScreenManager))return console.error("TM.InputManager_Keyboard ERROR: 'getText' function requires TMS instant(TM.ScreenManager)"),!1;if(this.textBox.dom)return!1;this.textBox.callback=e,this.textBox.maxLength=t,this.textBox.cursorSnap=TMS.cursor.copy(),TMS.cursor.pin(),TMS.cursor.show(),this.textBox.dom=document.createElement("input"),this.textBox.dom.type="text",this.textBox.dom.maxLength=t,this.textBox.dom.style.position="absolute",this.textBox.dom.style.top="-"+TMS.blockHeight+"px",this.textBox.dom.style.left=0,TMS.canvasContainer.appendChild(this.textBox.dom),TMS.canvas.addEventListener("focus",this.eventHandlers.textBoxFocus),this.textBox.dom.addEventListener("keydown",this.eventHandlers.textBoxKeydown),this.textBox.dom.focus();var r=this;return this.textBox.interval=window.setInterval(function(){r.textBox.dom.selectionStart=r.textBox.dom.value.length,r.textBox.dom.selectionEnd=r.textBox.dom.value.length,r.textBox.value!=r.textBox.dom.value&&r.truncateText()},40),!0},TM.InputManager_Keyboard.prototype.updateText=function(t){return!!this.textBox.dom&&(this.textBox.dom.value=t,!0)},TM.InputManager_Keyboard.prototype.truncateText=function(){for(var t=this.textBox.dom.value,e=t.replace(TMS.FullwidthRegex,"$1 ").length,r=!1;e>this.textBox.maxLength;)r=!0,e=(t=t.slice(0,t.length-1)).replace(TMS.FullwidthRegex,"$1 ").length;this.textBox.value=t,r&&(this.textBox.dom.value=t),TMS.cursor.unpin(),TMS.insertTextAt(this.textBox.cursorSnap.x,this.textBox.cursorSnap.y,t),TMS.cursor.pin();for(var n=this.textBox.maxLength-e,o=0;o<n;o++)TMS.insertText(" ")},TM.InputManager_Keyboard.prototype.checkKeyState=function(t){return!!this.keyState[t]},TM.InputManager_Keyboard.prototype.checkKeyStateAny=function(){return!!Object.keys(this.keyState).length},TM.InputManager_Keyboard.prototype.removeKeyState=function(t){delete this.keyState[t]},TM.InputManager_Keyboard.prototype.clearKeyState=function(){this.keyState={}},TM.InputManager_Keyboard.prototype.checkKeyPressed=function(t){return!!this.keyPressed[t]&&(delete this.keyPressed[t],!0)},TM.InputManager_Keyboard.prototype.checkKeyPressedAny=function(){return!!Object.keys(this.keyPressed).length&&(this.keyPressed={},!0)},TM.InputManager_Keyboard.prototype.removeKeyPressed=function(t){delete this.keyPressed[t]},TM.InputManager_Keyboard.prototype.clearKeyPressed=function(){this.keyPressed={}},TM.InputManager_Keyboard.prototype.checkKey=function(t){return this.checkKeyPressed(t)||this.checkKeyState(t)},TM.InputManager_Keyboard.prototype.checkKeyAny=function(){return this.checkKeyPressedAny()||this.checkKeyStateAny()},TM.InputManager_Keyboard.prototype.removeKey=function(t){this.removeKeyPressed(t),this.removeKeyState(t)},TM.InputManager_Keyboard.prototype.clearKey=function(){this.clearKeyPressed(),this.clearKeyState()},TM.InputManager_Keyboard.prototype.getInput=function(t){return prompt(t)},TM.InputManager=function(t,e){var r=t||TM.defaultSettings.screen.canvasId;try{if(this.targetDom=document.querySelector("#"+r),!this.targetDom)throw"[#"+domId+"] does not exist! "}catch(t){return this.isActive=!1,void console.error("new TM.InputManager ERROR: "+t+" TM.InputManager is not created.")}this.devMode=e,this.keyboard=new TM.InputManager_Keyboard(this),TM.IObject.call(this)},TM.InputManager.prototype=Object.create(TM.IObject.prototype),TM.InputManager.prototype.constructor=TM.InputManager,TM.InputManager.prototype._init=function(){},TM.InputManager.prototype._inactivate=function(){this.keyboard.inactivate()},TM.DebugManager=function(t){this.debugSetting=TM.common.mergeObjects(TM.defaultSettings.debug,t);try{if(this.outputDom=document.querySelector("#"+this.debugSetting.outputDomId),!this.outputDom)throw"[#"+this.debugSetting.outputDomId+"] does not exist! "}catch(t){return this.isActive=!1,void console.error("new TM.DebugManager ERROR: "+t+" TM.DebugManager is not created.")}this.doms={},TM.IObject.call(this)},TM.DebugManager.prototype=Object.create(TM.IObject.prototype),TM.DebugManager.prototype.constructor=TM.DebugManager,TM.DebugManager.prototype._init=function(){},TM.DebugManager.prototype._inactivate=function(){this.deleteAll()},TM.DebugManager.prototype.replacer=function(){var r=[];return function(t,e){if(e&&"object"==typeof e&&-1<r.indexOf(e))return"[Circular]";return r.push(e),e}},TM.DebugManager.prototype.print=function(t,e){if(this.debugSetting.devMode&&this.isActive){this.doms[t]||(this.doms[t]=document.createElement("pre"),this.outputDom.appendChild(this.doms[t]));var r="-- "+t+" --\n",n=JSON.stringify(e,this.replacer(e),2);this.doms[t].innerHTML=r+n}else this.delete(t)},TM.DebugManager.prototype.delete=function(t){this.doms[t]&&(this.doms[t].remove?this.doms[t].remove():this.doms[t].parentElement.removeChild(this.doms[t]),delete this.doms[t])},TM.DebugManager.prototype.deleteAll=function(){for(var t in this.doms)this.delete(t)};